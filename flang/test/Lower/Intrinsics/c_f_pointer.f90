! RUN: bbc -emit-fir %s -o - | FileCheck %s
! NOTE: Assertions have been autogenerated by utils/generate-test-checks.py

subroutine sub_scalar(x, a)
  use iso_c_binding, only: c_ptr, c_f_pointer
  implicit none
  type(c_ptr) :: x
  real, pointer :: a

  call c_f_pointer(x, a)
end subroutine sub_scalar

function fun_scalar(x)
  use iso_c_binding, only: c_ptr, c_f_pointer
  implicit none
  type(c_ptr) :: x
  real, pointer :: fun_scalar

  call c_f_pointer(x, fun_scalar)
end function fun_scalar

subroutine sub_scalar_2(x, a)
  use iso_c_binding, only: c_ptr, c_f_pointer
  implicit none
  type(c_ptr) :: x
  real, pointer :: a, tmp

  call c_f_pointer(x, tmp)
  a => tmp
end subroutine sub_scalar_2

subroutine sub_array(a, x, s)
  use iso_c_binding, only: c_ptr, c_f_pointer
  implicit none
  type(c_ptr) :: x
  real, pointer :: a(:, :)
  integer :: s(2)

  call c_f_pointer(x, a, s)
end subroutine sub_array

function sub_array_fun(x, s)
  use iso_c_binding, only: c_ptr, c_f_pointer
  implicit none
  type(c_ptr) :: x
  real, pointer :: sub_array_fun(:, :)
  integer :: s(2)

  call c_f_pointer(x, sub_array_fun, s)
end function sub_array_fun

subroutine sub_array_literal(a, x)
  use iso_c_binding, only: c_ptr, c_f_pointer
  implicit none
  type(c_ptr) :: x
  real, pointer :: a(:, :)

  call c_f_pointer(x, a, [10, 20])
end subroutine sub_array_literal

! CHECK-LABEL: func @_QPsub_scalar(
! CHECK-SAME:                      %[[VAL_0:.*]]: !fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>> {fir.bindc_name = "x"},
! CHECK-SAME:                      %[[VAL_1:.*]]: !fir.ref<!fir.box<!fir.ptr<f32>>> {fir.bindc_name = "a"}) {
! CHECK:         %[[VAL_2:.*]] = fir.field_index __address, !fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>
! CHECK:         %[[VAL_3:.*]] = fir.coordinate_of %[[VAL_0]], %[[VAL_2]] : (!fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>>, !fir.field) -> !fir.ref<i64>
! CHECK:         %[[VAL_4:.*]] = fir.load %[[VAL_3]] : !fir.ref<i64>
! CHECK:         %[[VAL_5:.*]] = fir.convert %[[VAL_4]] : (i64) -> !fir.ptr<f32>
! CHECK:         %[[VAL_6:.*]] = fir.embox %[[VAL_5]] : (!fir.ptr<f32>) -> !fir.box<!fir.ptr<f32>>
! CHECK:         fir.store %[[VAL_6]] to %[[VAL_1]] : !fir.ref<!fir.box<!fir.ptr<f32>>>
! CHECK:         return
! CHECK:       }
!
! CHECK-LABEL: func @_QPfun_scalar(
! CHECK-SAME:                      %[[VAL_0:.*]]: !fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>> {fir.bindc_name = "x"}) -> !fir.box<!fir.ptr<f32>> {
! CHECK:         %[[VAL_1:.*]] = fir.alloca !fir.box<!fir.ptr<f32>> {bindc_name = "fun_scalar", uniq_name = "_QFfun_scalarEfun_scalar"}
! CHECK:         %[[VAL_2:.*]] = fir.zero_bits !fir.ptr<f32>
! CHECK:         %[[VAL_3:.*]] = fir.embox %[[VAL_2]] : (!fir.ptr<f32>) -> !fir.box<!fir.ptr<f32>>
! CHECK:         fir.store %[[VAL_3]] to %[[VAL_1]] : !fir.ref<!fir.box<!fir.ptr<f32>>>
! CHECK:         %[[VAL_4:.*]] = fir.field_index __address, !fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>
! CHECK:         %[[VAL_5:.*]] = fir.coordinate_of %[[VAL_0]], %[[VAL_4]] : (!fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>>, !fir.field) -> !fir.ref<i64>
! CHECK:         %[[VAL_6:.*]] = fir.load %[[VAL_5]] : !fir.ref<i64>
! CHECK:         %[[VAL_7:.*]] = fir.convert %[[VAL_6]] : (i64) -> !fir.ptr<f32>
! CHECK:         %[[VAL_8:.*]] = fir.embox %[[VAL_7]] : (!fir.ptr<f32>) -> !fir.box<!fir.ptr<f32>>
! CHECK:         fir.store %[[VAL_8]] to %[[VAL_1]] : !fir.ref<!fir.box<!fir.ptr<f32>>>
! CHECK:         %[[VAL_9:.*]] = fir.load %[[VAL_1]] : !fir.ref<!fir.box<!fir.ptr<f32>>>
! CHECK:         return %[[VAL_9]] : !fir.box<!fir.ptr<f32>>
! CHECK:       }
!
! CHECK-LABEL: func @_QPsub_scalar_2(
! CHECK-SAME:                        %[[VAL_0:.*]]: !fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>> {fir.bindc_name = "x"},
! CHECK-SAME:                        %[[VAL_1:.*]]: !fir.ref<!fir.box<!fir.ptr<f32>>> {fir.bindc_name = "a"}) {
! CHECK:         %[[VAL_2:.*]] = fir.alloca !fir.box<!fir.ptr<f32>> {bindc_name = "tmp", uniq_name = "_QFsub_scalar_2Etmp"}
! CHECK:         %[[VAL_3:.*]] = fir.alloca !fir.ptr<f32> {uniq_name = "_QFsub_scalar_2Etmp.addr"}
! CHECK:         %[[VAL_4:.*]] = fir.zero_bits !fir.ptr<f32>
! CHECK:         fir.store %[[VAL_4]] to %[[VAL_3]] : !fir.ref<!fir.ptr<f32>>
! CHECK:         %[[VAL_5:.*]] = fir.field_index __address, !fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>
! CHECK:         %[[VAL_6:.*]] = fir.coordinate_of %[[VAL_0]], %[[VAL_5]] : (!fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>>, !fir.field) -> !fir.ref<i64>
! CHECK:         %[[VAL_7:.*]] = fir.load %[[VAL_6]] : !fir.ref<i64>
! CHECK:         %[[VAL_8:.*]] = fir.convert %[[VAL_7]] : (i64) -> !fir.ptr<f32>
! CHECK:         %[[VAL_9:.*]] = fir.embox %[[VAL_8]] : (!fir.ptr<f32>) -> !fir.box<!fir.ptr<f32>>
! CHECK:         fir.store %[[VAL_9]] to %[[VAL_2]] : !fir.ref<!fir.box<!fir.ptr<f32>>>
! CHECK:         %[[VAL_10:.*]] = fir.load %[[VAL_2]] : !fir.ref<!fir.box<!fir.ptr<f32>>>
! CHECK:         %[[VAL_11:.*]] = fir.box_addr %[[VAL_10]] : (!fir.box<!fir.ptr<f32>>) -> !fir.ptr<f32>
! CHECK:         fir.store %[[VAL_11]] to %[[VAL_3]] : !fir.ref<!fir.ptr<f32>>
! CHECK:         %[[VAL_12:.*]] = fir.load %[[VAL_3]] : !fir.ref<!fir.ptr<f32>>
! CHECK:         %[[VAL_13:.*]] = fir.embox %[[VAL_12]] : (!fir.ptr<f32>) -> !fir.box<!fir.ptr<f32>>
! CHECK:         fir.store %[[VAL_13]] to %[[VAL_1]] : !fir.ref<!fir.box<!fir.ptr<f32>>>
! CHECK:         return
! CHECK:       }
!
! CHECK-LABEL: func @_QPsub_array(
! CHECK-SAME:                     %[[VAL_0:.*]]: !fir.ref<!fir.box<!fir.ptr<!fir.array<?x?xf32>>>> {fir.bindc_name = "a"},
! CHECK-SAME:                     %[[VAL_1:.*]]: !fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>> {fir.bindc_name = "x"},
! CHECK-SAME:                     %[[VAL_2:.*]]: !fir.ref<!fir.array<2xi32>> {fir.bindc_name = "s"}) {
! CHECK:         %[[VAL_3:.*]] = fir.field_index __address, !fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>
! CHECK:         %[[VAL_4:.*]] = fir.coordinate_of %[[VAL_1]], %[[VAL_3]] : (!fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>>, !fir.field) -> !fir.ref<i64>
! CHECK:         %[[VAL_5:.*]] = fir.load %[[VAL_4]] : !fir.ref<i64>
! CHECK:         %[[VAL_6:.*]] = fir.convert %[[VAL_5]] : (i64) -> !fir.ptr<!fir.array<?x?xf32>>
! CHECK:         %[[VAL_7:.*]] = arith.constant 0 : i32
! CHECK:         %[[VAL_8:.*]] = fir.coordinate_of %[[VAL_2]], %[[VAL_7]] : (!fir.ref<!fir.array<2xi32>>, i32) -> !fir.ref<i32>
! CHECK:         %[[VAL_9:.*]] = fir.load %[[VAL_8]] : !fir.ref<i32>
! CHECK:         %[[VAL_10:.*]] = arith.constant 1 : i32
! CHECK:         %[[VAL_11:.*]] = fir.coordinate_of %[[VAL_2]], %[[VAL_10]] : (!fir.ref<!fir.array<2xi32>>, i32) -> !fir.ref<i32>
! CHECK:         %[[VAL_12:.*]] = fir.load %[[VAL_11]] : !fir.ref<i32>
! CHECK:         %[[VAL_13:.*]] = fir.convert %[[VAL_9]] : (i32) -> index
! CHECK:         %[[VAL_14:.*]] = fir.convert %[[VAL_12]] : (i32) -> index
! CHECK:         %[[VAL_15:.*]] = fir.shape %[[VAL_13]], %[[VAL_14]] : (index, index) -> !fir.shape<2>
! CHECK:         %[[VAL_16:.*]] = fir.embox %[[VAL_6]](%[[VAL_15]]) : (!fir.ptr<!fir.array<?x?xf32>>, !fir.shape<2>) -> !fir.box<!fir.ptr<!fir.array<?x?xf32>>>
! CHECK:         fir.store %[[VAL_16]] to %[[VAL_0]] : !fir.ref<!fir.box<!fir.ptr<!fir.array<?x?xf32>>>>
! CHECK:         return
! CHECK:       }
!
! CHECK-LABEL: func @_QPsub_array_fun(
! CHECK-SAME:                         %[[VAL_0:.*]]: !fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>> {fir.bindc_name = "x"},
! CHECK-SAME:                         %[[VAL_1:.*]]: !fir.ref<!fir.array<2xi32>> {fir.bindc_name = "s"}) -> !fir.box<!fir.ptr<!fir.array<?x?xf32>>> {
! CHECK:         %[[VAL_2:.*]] = fir.alloca !fir.box<!fir.ptr<!fir.array<?x?xf32>>> {bindc_name = "sub_array_fun", uniq_name = "_QFsub_array_funEsub_array_fun"}
! CHECK:         %[[VAL_3:.*]] = fir.zero_bits !fir.ptr<!fir.array<?x?xf32>>
! CHECK:         %[[VAL_4:.*]] = arith.constant 0 : index
! CHECK:         %[[VAL_5:.*]] = fir.shape %[[VAL_4]], %[[VAL_4]] : (index, index) -> !fir.shape<2>
! CHECK:         %[[VAL_6:.*]] = fir.embox %[[VAL_3]](%[[VAL_5]]) : (!fir.ptr<!fir.array<?x?xf32>>, !fir.shape<2>) -> !fir.box<!fir.ptr<!fir.array<?x?xf32>>>
! CHECK:         fir.store %[[VAL_6]] to %[[VAL_2]] : !fir.ref<!fir.box<!fir.ptr<!fir.array<?x?xf32>>>>
! CHECK:         %[[VAL_7:.*]] = fir.field_index __address, !fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>
! CHECK:         %[[VAL_8:.*]] = fir.coordinate_of %[[VAL_0]], %[[VAL_7]] : (!fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>>, !fir.field) -> !fir.ref<i64>
! CHECK:         %[[VAL_9:.*]] = fir.load %[[VAL_8]] : !fir.ref<i64>
! CHECK:         %[[VAL_10:.*]] = fir.convert %[[VAL_9]] : (i64) -> !fir.ptr<!fir.array<?x?xf32>>
! CHECK:         %[[VAL_11:.*]] = arith.constant 0 : i32
! CHECK:         %[[VAL_12:.*]] = fir.coordinate_of %[[VAL_1]], %[[VAL_11]] : (!fir.ref<!fir.array<2xi32>>, i32) -> !fir.ref<i32>
! CHECK:         %[[VAL_13:.*]] = fir.load %[[VAL_12]] : !fir.ref<i32>
! CHECK:         %[[VAL_14:.*]] = arith.constant 1 : i32
! CHECK:         %[[VAL_15:.*]] = fir.coordinate_of %[[VAL_1]], %[[VAL_14]] : (!fir.ref<!fir.array<2xi32>>, i32) -> !fir.ref<i32>
! CHECK:         %[[VAL_16:.*]] = fir.load %[[VAL_15]] : !fir.ref<i32>
! CHECK:         %[[VAL_17:.*]] = fir.convert %[[VAL_13]] : (i32) -> index
! CHECK:         %[[VAL_18:.*]] = fir.convert %[[VAL_16]] : (i32) -> index
! CHECK:         %[[VAL_19:.*]] = fir.shape %[[VAL_17]], %[[VAL_18]] : (index, index) -> !fir.shape<2>
! CHECK:         %[[VAL_20:.*]] = fir.embox %[[VAL_10]](%[[VAL_19]]) : (!fir.ptr<!fir.array<?x?xf32>>, !fir.shape<2>) -> !fir.box<!fir.ptr<!fir.array<?x?xf32>>>
! CHECK:         fir.store %[[VAL_20]] to %[[VAL_2]] : !fir.ref<!fir.box<!fir.ptr<!fir.array<?x?xf32>>>>
! CHECK:         %[[VAL_21:.*]] = fir.load %[[VAL_2]] : !fir.ref<!fir.box<!fir.ptr<!fir.array<?x?xf32>>>>
! CHECK:         return %[[VAL_21]] : !fir.box<!fir.ptr<!fir.array<?x?xf32>>>
! CHECK:       }
!
! CHECK-LABEL: func @_QPsub_array_literal(
! CHECK-SAME:                             %[[VAL_0:.*]]: !fir.ref<!fir.box<!fir.ptr<!fir.array<?x?xf32>>>> {fir.bindc_name = "a"},
! CHECK-SAME:                             %[[VAL_1:.*]]: !fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>> {fir.bindc_name = "x"}) {
! CHECK:         %[[VAL_2:.*]] = arith.constant 2 : index
! CHECK:         %[[VAL_3:.*]] = fir.address_of(@_QQro.2xi4.aa744c611bd27c055c64aac347aa01be) : !fir.ref<!fir.array<2xi32>>
! CHECK:         %[[VAL_4:.*]] = arith.constant 2 : index
! CHECK:         %[[VAL_5:.*]] = fir.shape %[[VAL_4]] : (index) -> !fir.shape<1>
! CHECK:         %[[VAL_6:.*]] = fir.array_load %[[VAL_3]](%[[VAL_5]]) : (!fir.ref<!fir.array<2xi32>>, !fir.shape<1>) -> !fir.array<2xi32>
! CHECK:         %[[VAL_7:.*]] = fir.allocmem !fir.array<2xi32>
! CHECK:         %[[VAL_8:.*]] = fir.shape %[[VAL_2]] : (index) -> !fir.shape<1>
! CHECK:         %[[VAL_9:.*]] = fir.array_load %[[VAL_7]](%[[VAL_8]]) : (!fir.heap<!fir.array<2xi32>>, !fir.shape<1>) -> !fir.array<2xi32>
! CHECK:         %[[VAL_10:.*]] = arith.constant 1 : index
! CHECK:         %[[VAL_11:.*]] = arith.constant 0 : index
! CHECK:         %[[VAL_12:.*]] = arith.subi %[[VAL_2]], %[[VAL_10]] : index
! CHECK:         %[[VAL_13:.*]] = fir.do_loop %[[VAL_14:.*]] = %[[VAL_11]] to %[[VAL_12]] step %[[VAL_10]] unordered iter_args(%[[VAL_15:.*]] = %[[VAL_9]]) -> (!fir.array<2xi32>) {
! CHECK:           %[[VAL_16:.*]] = fir.array_fetch %[[VAL_6]], %[[VAL_14]] : (!fir.array<2xi32>, index) -> i32
! CHECK:           %[[VAL_17:.*]] = fir.array_update %[[VAL_15]], %[[VAL_16]], %[[VAL_14]] : (!fir.array<2xi32>, i32, index) -> !fir.array<2xi32>
! CHECK:           fir.result %[[VAL_17]] : !fir.array<2xi32>
! CHECK:         }
! CHECK:         fir.array_merge_store %[[VAL_9]], %[[VAL_18:.*]] to %[[VAL_7]] : !fir.array<2xi32>, !fir.array<2xi32>, !fir.heap<!fir.array<2xi32>>
! CHECK:         %[[VAL_19:.*]] = fir.field_index __address, !fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>
! CHECK:         %[[VAL_20:.*]] = fir.coordinate_of %[[VAL_1]], %[[VAL_19]] : (!fir.ref<!fir.type<_QM__fortran_builtinsT__builtin_c_ptr{__address:i64}>>, !fir.field) -> !fir.ref<i64>
! CHECK:         %[[VAL_21:.*]] = fir.load %[[VAL_20]] : !fir.ref<i64>
! CHECK:         %[[VAL_22:.*]] = fir.convert %[[VAL_21]] : (i64) -> !fir.ptr<!fir.array<?x?xf32>>
! CHECK:         %[[VAL_23:.*]] = arith.constant 0 : i32
! CHECK:         %[[VAL_24:.*]] = fir.coordinate_of %[[VAL_7]], %[[VAL_23]] : (!fir.heap<!fir.array<2xi32>>, i32) -> !fir.ref<i32>
! CHECK:         %[[VAL_25:.*]] = fir.load %[[VAL_24]] : !fir.ref<i32>
! CHECK:         %[[VAL_26:.*]] = arith.constant 1 : i32
! CHECK:         %[[VAL_27:.*]] = fir.coordinate_of %[[VAL_7]], %[[VAL_26]] : (!fir.heap<!fir.array<2xi32>>, i32) -> !fir.ref<i32>
! CHECK:         %[[VAL_28:.*]] = fir.load %[[VAL_27]] : !fir.ref<i32>
! CHECK:         %[[VAL_29:.*]] = fir.convert %[[VAL_25]] : (i32) -> index
! CHECK:         %[[VAL_30:.*]] = fir.convert %[[VAL_28]] : (i32) -> index
! CHECK:         %[[VAL_31:.*]] = fir.shape %[[VAL_29]], %[[VAL_30]] : (index, index) -> !fir.shape<2>
! CHECK:         %[[VAL_32:.*]] = fir.embox %[[VAL_22]](%[[VAL_31]]) : (!fir.ptr<!fir.array<?x?xf32>>, !fir.shape<2>) -> !fir.box<!fir.ptr<!fir.array<?x?xf32>>>
! CHECK:         fir.store %[[VAL_32]] to %[[VAL_0]] : !fir.ref<!fir.box<!fir.ptr<!fir.array<?x?xf32>>>>
! CHECK:         fir.freemem %[[VAL_7]] : !fir.heap<!fir.array<2xi32>>
! CHECK:         return
! CHECK:       }
